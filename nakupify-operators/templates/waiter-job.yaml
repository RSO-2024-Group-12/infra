# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: wait-for-operator-crds
#   annotations:
#     "helm.sh/hook": "pre-install,pre-upgrade"
#     "helm.sh/hook-weight": "1"
#     "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
# spec:
#   backoffLimit: 0
#   template:
#     spec:
#       restartPolicy: Never
#       serviceAccountName: crd-reader
#       containers:
#         - name: wait
#           image: bitnami/kubectl:latest
#           command:
#             - /bin/bash
#             - -c
#             - |
#               set -e
#               set -x

#               CRDS="
#               keycloaks.k8s.keycloak.org
#               keycloakrealmimports.k8s.keycloak.org
#               crunchybridgeclusters.postgres-operator.crunchydata.com
#               pgadmins.postgres-operator.crunchydata.com
#               pgupgrades.postgres-operator.crunchydata.com
#               postgresclusters.postgres-operator.crunchydata.com
#               "

#               echo "Waiting for CRDs to be established"

#               until true; do
#                 all_established=true
#                 for crd in $CRDS; do
#                   if ! kubectl get crd/$crd >/dev/null 2>&1; then
#                     all_established=false
#                     break
#                   fi
#                 done

#                 if $all_established; then
#                   break
#                 fi

#                 sleep 2
#               done

#               for crd in $CRDS; do
#                 echo "Waiting for CRD $crd"
#                 kubectl wait \
#                   --namespace {{ .Release.Namespace }} \
#                   --for=condition=Established \
#                   crd/$crd \
#                   --timeout=0s
#               done

#               echo "All CRDs are established"